<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.48">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <link rel="icon" href="/PolarDB-for-PostgreSQL/favicon.ico"><title>PolarDB PG 备份恢复 | PolarDB for PostgreSQL</title><meta name="description" content="阿里云自主研发的云原生数据库产品">
    <link rel="modulepreload" href="/PolarDB-for-PostgreSQL/assets/app.d42591db.js"><link rel="modulepreload" href="/PolarDB-for-PostgreSQL/assets/backup-and-restore.html.8ada5f39.js"><link rel="modulepreload" href="/PolarDB-for-PostgreSQL/assets/backup-and-restore.html.8f33256e.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/index.html.db69ef4f.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/index.html.0301697a.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/buffer-management.html.47975b93.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/ddl-synchronization.html.3b8a1266.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/logindex.html.9a8cd7c2.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/code-of-conduct.html.a7a8e6e6.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/coding-style.html.9e53a436.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/contributing-polardb-docs.html.72118595.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/contributing-polardb-kernel.html.14782f17.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/backup-and-restore.html.0295ae9a.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/customize-dev-env.html.29f0b38d.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/db-localfs.html.a4e65eca.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/db-pfs.html.c2eb34b4.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/deploy-more.html.23ffeefb.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/deploy.html.d8890f08.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/fs-pfs.html.4df59ec7.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/introduction.html.da125601.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/quick-start.html.ef836136.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/storage-aliyun-essd.html.079f4bcb.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/storage-ceph.html.639cb75e.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/storage-nbd.html.97a6748f.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/tpch-on-px.html.de73af08.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/index.html.45a5c105.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/index.html.31b2c184.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/index.html.1db4199f.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/buffer-management.html.66aae055.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/ddl-synchronization.html.f6764097.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/logindex.html.92c8ae1a.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/code-of-conduct.html.a542926b.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/coding-style.html.66db37ce.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/contributing-polardb-docs.html.fa69e2e1.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/contributing-polardb-kernel.html.b3ee1915.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/customize-dev-env.html.fb2f61a2.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/db-localfs.html.5c431922.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/db-pfs.html.4b059ea5.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/deploy-more.html.325d5e8c.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/deploy.html.5287d6a7.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/fs-pfs.html.1669bf70.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/introduction.html.7de48efb.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/quick-start.html.b3ae278e.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/storage-aliyun-essd.html.33dc885a.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/storage-ceph.html.48bcbaf7.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/storage-nbd.html.83e598e1.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/tpch-on-px.html.e355841c.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/index.html.189b0b4b.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/404.html.7d858b3d.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/index.html.358c28c3.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/index.html.dcf3959e.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/buffer-management.html.a7186013.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/ddl-synchronization.html.0ea1773a.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/logindex.html.7cb4da4f.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/code-of-conduct.html.d46af91c.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/coding-style.html.e04b1b51.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/contributing-polardb-docs.html.e71d72e0.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/contributing-polardb-kernel.html.d7edc571.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/backup-and-restore.html.46cd8ea9.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/customize-dev-env.html.0d681be1.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/db-localfs.html.29fcbb27.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/db-pfs.html.21faee81.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/deploy-more.html.d2e23484.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/deploy.html.f72f4f7e.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/fs-pfs.html.52df28cd.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/introduction.html.fa7ac828.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/quick-start.html.cc6e9add.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/storage-aliyun-essd.html.8326c58c.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/storage-ceph.html.ebe2beef.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/storage-nbd.html.829a9172.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/tpch-on-px.html.0d2523ae.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/index.html.d1177051.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/index.html.aec16a5b.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/index.html.cba6956a.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/buffer-management.html.baee66b6.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/ddl-synchronization.html.42b001eb.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/logindex.html.c5a90fb8.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/code-of-conduct.html.503467e6.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/coding-style.html.6b57382b.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/contributing-polardb-docs.html.cc08517c.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/contributing-polardb-kernel.html.8b4735c3.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/customize-dev-env.html.14c0935f.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/db-localfs.html.2cf423b2.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/db-pfs.html.facdb13b.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/deploy-more.html.e242d4ce.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/deploy.html.c0edfb4b.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/fs-pfs.html.baacc9da.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/introduction.html.10dfed4a.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/quick-start.html.afd4935e.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/storage-aliyun-essd.html.972c34aa.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/storage-ceph.html.cb3e53f6.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/storage-nbd.html.29be4ac5.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/tpch-on-px.html.da327600.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/index.html.513b9f98.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/404.html.a21b721e.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/404.7522534e.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/Layout.3bfd0c7a.js">
    <link rel="stylesheet" href="/PolarDB-for-PostgreSQL/assets/style.66c1f8f6.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/PolarDB-for-PostgreSQL/zh/" class=""><img class="logo" src="/PolarDB-for-PostgreSQL/images/polardb.png" alt="PolarDB for PostgreSQL"><span class="site-name can-hide">PolarDB for PostgreSQL</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="入门指南"><span class="title">入门指南</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="入门指南"><span class="title">入门指南</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/zh/guide/quick-start.html" class="" aria-label="快速上手"><!--[--><!--]--> 快速上手 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/zh/guide/introduction.html" class="" aria-label="PolarDB 架构简介"><!--[--><!--]--> PolarDB 架构简介 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/zh/guide/deploy.html" class="" aria-label="进阶部署"><!--[--><!--]--> 进阶部署 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>准备块存储设备</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/PolarDB-for-PostgreSQL/zh/guide/storage-ceph.html" class="" aria-label="Ceph 共享存储"><!--[--><!--]--> Ceph 共享存储 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/PolarDB-for-PostgreSQL/zh/guide/storage-aliyun-essd.html" class="" aria-label="阿里云 ECS + ESSD 云盘存储"><!--[--><!--]--> 阿里云 ECS + ESSD 云盘存储 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/PolarDB-for-PostgreSQL/zh/guide/storage-nbd.html" class="" aria-label="NBD 共享存储"><!--[--><!--]--> NBD 共享存储 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>准备文件系统</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/PolarDB-for-PostgreSQL/zh/guide/fs-pfs.html" class="" aria-label="格式化并挂载 PFS"><!--[--><!--]--> 格式化并挂载 PFS <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>编译部署 PolarDB 内核</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/PolarDB-for-PostgreSQL/zh/guide/db-localfs.html" class="" aria-label="PolarDB 编译部署：单机文件系统"><!--[--><!--]--> PolarDB 编译部署：单机文件系统 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/PolarDB-for-PostgreSQL/zh/guide/db-pfs.html" class="" aria-label="PolarDB 编译部署：PFS 文件系统"><!--[--><!--]--> PolarDB 编译部署：PFS 文件系统 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>更多</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/PolarDB-for-PostgreSQL/zh/guide/customize-dev-env.html" class="" aria-label="定制开发环境"><!--[--><!--]--> 定制开发环境 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/PolarDB-for-PostgreSQL/zh/guide/deploy-more.html" class="" aria-label="更多部署方式"><!--[--><!--]--> 更多部署方式 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>特性体验</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/PolarDB-for-PostgreSQL/zh/guide/tpch-on-px.html" class="" aria-label="利用 PolarDB HTAP 加速 TPC-H"><!--[--><!--]--> 利用 PolarDB HTAP 加速 TPC-H <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="架构解读"><span class="title">架构解读</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="架构解读"><span class="title">架构解读</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/zh/architecture/" class="" aria-label="架构详解"><!--[--><!--]--> 架构详解 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/zh/architecture/buffer-management.html" class="" aria-label="缓冲区管理"><!--[--><!--]--> 缓冲区管理 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/zh/architecture/ddl-synchronization.html" class="" aria-label="DDL 同步"><!--[--><!--]--> DDL 同步 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/zh/architecture/logindex.html" class="" aria-label="LogIndex"><!--[--><!--]--> LogIndex <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a href="/PolarDB-for-PostgreSQL/zh/roadmap/" class="" aria-label="版本规划"><!--[--><!--]--> 版本规划 <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="参与社区"><span class="title">参与社区</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="参与社区"><span class="title">参与社区</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/zh/contributing/contributing-polardb-kernel.html" class="" aria-label="贡献代码"><!--[--><!--]--> 贡献代码 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/zh/contributing/contributing-polardb-docs.html" class="" aria-label="贡献文档"><!--[--><!--]--> 贡献文档 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/zh/contributing/coding-style.html" class="" aria-label="编码风格"><!--[--><!--]--> 编码风格 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/zh/contributing/code-of-conduct.html" class="" aria-label="行为准则"><!--[--><!--]--> 行为准则 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="选择语言"><span class="title">选择语言</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="选择语言"><span class="title">选择语言</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/guide/backup-and-restore.html" class="" aria-label="English"><!--[--><!--]--> English <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a aria-current="page" href="/PolarDB-for-PostgreSQL/zh/guide/backup-and-restore.html" class="router-link-active router-link-exact-active router-link-active" aria-label="简体中文"><!--[--><!--]--> 简体中文 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/ApsaraDB/PolarDB-for-PostgreSQL" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><div id="docsearch-container"></div></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="入门指南"><span class="title">入门指南</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="入门指南"><span class="title">入门指南</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/zh/guide/quick-start.html" class="" aria-label="快速上手"><!--[--><!--]--> 快速上手 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/zh/guide/introduction.html" class="" aria-label="PolarDB 架构简介"><!--[--><!--]--> PolarDB 架构简介 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/zh/guide/deploy.html" class="" aria-label="进阶部署"><!--[--><!--]--> 进阶部署 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>准备块存储设备</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/PolarDB-for-PostgreSQL/zh/guide/storage-ceph.html" class="" aria-label="Ceph 共享存储"><!--[--><!--]--> Ceph 共享存储 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/PolarDB-for-PostgreSQL/zh/guide/storage-aliyun-essd.html" class="" aria-label="阿里云 ECS + ESSD 云盘存储"><!--[--><!--]--> 阿里云 ECS + ESSD 云盘存储 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/PolarDB-for-PostgreSQL/zh/guide/storage-nbd.html" class="" aria-label="NBD 共享存储"><!--[--><!--]--> NBD 共享存储 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>准备文件系统</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/PolarDB-for-PostgreSQL/zh/guide/fs-pfs.html" class="" aria-label="格式化并挂载 PFS"><!--[--><!--]--> 格式化并挂载 PFS <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>编译部署 PolarDB 内核</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/PolarDB-for-PostgreSQL/zh/guide/db-localfs.html" class="" aria-label="PolarDB 编译部署：单机文件系统"><!--[--><!--]--> PolarDB 编译部署：单机文件系统 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/PolarDB-for-PostgreSQL/zh/guide/db-pfs.html" class="" aria-label="PolarDB 编译部署：PFS 文件系统"><!--[--><!--]--> PolarDB 编译部署：PFS 文件系统 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>更多</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/PolarDB-for-PostgreSQL/zh/guide/customize-dev-env.html" class="" aria-label="定制开发环境"><!--[--><!--]--> 定制开发环境 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/PolarDB-for-PostgreSQL/zh/guide/deploy-more.html" class="" aria-label="更多部署方式"><!--[--><!--]--> 更多部署方式 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>特性体验</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/PolarDB-for-PostgreSQL/zh/guide/tpch-on-px.html" class="" aria-label="利用 PolarDB HTAP 加速 TPC-H"><!--[--><!--]--> 利用 PolarDB HTAP 加速 TPC-H <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="架构解读"><span class="title">架构解读</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="架构解读"><span class="title">架构解读</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/zh/architecture/" class="" aria-label="架构详解"><!--[--><!--]--> 架构详解 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/zh/architecture/buffer-management.html" class="" aria-label="缓冲区管理"><!--[--><!--]--> 缓冲区管理 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/zh/architecture/ddl-synchronization.html" class="" aria-label="DDL 同步"><!--[--><!--]--> DDL 同步 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/zh/architecture/logindex.html" class="" aria-label="LogIndex"><!--[--><!--]--> LogIndex <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a href="/PolarDB-for-PostgreSQL/zh/roadmap/" class="" aria-label="版本规划"><!--[--><!--]--> 版本规划 <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="参与社区"><span class="title">参与社区</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="参与社区"><span class="title">参与社区</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/zh/contributing/contributing-polardb-kernel.html" class="" aria-label="贡献代码"><!--[--><!--]--> 贡献代码 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/zh/contributing/contributing-polardb-docs.html" class="" aria-label="贡献文档"><!--[--><!--]--> 贡献文档 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/zh/contributing/coding-style.html" class="" aria-label="编码风格"><!--[--><!--]--> 编码风格 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/zh/contributing/code-of-conduct.html" class="" aria-label="行为准则"><!--[--><!--]--> 行为准则 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="选择语言"><span class="title">选择语言</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="选择语言"><span class="title">选择语言</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/guide/backup-and-restore.html" class="" aria-label="English"><!--[--><!--]--> English <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a aria-current="page" href="/PolarDB-for-PostgreSQL/zh/guide/backup-and-restore.html" class="router-link-active router-link-exact-active router-link-active" aria-label="简体中文"><!--[--><!--]--> 简体中文 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/ApsaraDB/PolarDB-for-PostgreSQL" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading active">入门指南 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/PolarDB-for-PostgreSQL/zh/guide/quick-start.html" class="sidebar-item" aria-label="快速上手"><!--[--><!--]--> 快速上手 <!--[--><!--]--></a><!----></li><li><a href="/PolarDB-for-PostgreSQL/zh/guide/introduction.html" class="sidebar-item" aria-label="PolarDB 架构简介"><!--[--><!--]--> PolarDB 架构简介 <!--[--><!--]--></a><!----></li><li><a href="/PolarDB-for-PostgreSQL/zh/guide/deploy.md" class="sidebar-item" aria-label="进阶部署"><!--[--><!--]--> 进阶部署 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><p tabindex="0" class="sidebar-item">一、准备块存储设备 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/PolarDB-for-PostgreSQL/zh/guide/storage-aliyun-essd.html" class="sidebar-item" aria-label="阿里云 ECS + ESSD 云盘存储"><!--[--><!--]--> 阿里云 ECS + ESSD 云盘存储 <!--[--><!--]--></a><!----></li><li><a href="/PolarDB-for-PostgreSQL/zh/guide/storage-ceph.html" class="sidebar-item" aria-label="Ceph 共享存储"><!--[--><!--]--> Ceph 共享存储 <!--[--><!--]--></a><!----></li><li><a href="/PolarDB-for-PostgreSQL/zh/guide/storage-nbd.html" class="sidebar-item" aria-label="NBD 共享存储"><!--[--><!--]--> NBD 共享存储 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item">二、准备文件系统 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/PolarDB-for-PostgreSQL/zh/guide/fs-pfs.html" class="sidebar-item" aria-label="格式化并挂载 PFS"><!--[--><!--]--> 格式化并挂载 PFS <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item">三、编译部署 PolarDB 内核 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/PolarDB-for-PostgreSQL/zh/guide/db-localfs.html" class="sidebar-item" aria-label="PolarDB 编译部署：单机文件系统"><!--[--><!--]--> PolarDB 编译部署：单机文件系统 <!--[--><!--]--></a><!----></li><li><a href="/PolarDB-for-PostgreSQL/zh/guide/db-pfs.html" class="sidebar-item" aria-label="PolarDB 编译部署：PFS 文件系统"><!--[--><!--]--> PolarDB 编译部署：PFS 文件系统 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><a aria-current="page" href="/PolarDB-for-PostgreSQL/zh/guide/backup-and-restore.html" class="router-link-active router-link-exact-active router-link-active sidebar-item active" aria-label="PolarDB PG 备份恢复"><!--[--><!--]--> PolarDB PG 备份恢复 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/PolarDB-for-PostgreSQL/zh/guide/backup-and-restore.html#备份恢复原理" class="router-link-active router-link-exact-active sidebar-item" aria-label="备份恢复原理"><!--[--><!--]--> 备份恢复原理 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/PolarDB-for-PostgreSQL/zh/guide/backup-and-restore.html#目录结构" class="router-link-active router-link-exact-active sidebar-item" aria-label="目录结构"><!--[--><!--]--> 目录结构 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/PolarDB-for-PostgreSQL/zh/guide/backup-and-restore.html#polar-basebackup-备份工具" class="router-link-active router-link-exact-active sidebar-item" aria-label="polar_basebackup 备份工具"><!--[--><!--]--> polar_basebackup 备份工具 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/PolarDB-for-PostgreSQL/zh/guide/backup-and-restore.html#搭建-ro" class="router-link-active router-link-exact-active sidebar-item" aria-label="搭建 RO"><!--[--><!--]--> 搭建 RO <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/PolarDB-for-PostgreSQL/zh/guide/backup-and-restore.html#搭建-standby" class="router-link-active router-link-exact-active sidebar-item" aria-label="搭建 Standby"><!--[--><!--]--> 搭建 Standby <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/PolarDB-for-PostgreSQL/zh/guide/backup-and-restore.html#按时间点恢复" class="router-link-active router-link-exact-active sidebar-item" aria-label="按时间点恢复"><!--[--><!--]--> 按时间点恢复 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a href="/PolarDB-for-PostgreSQL/zh/guide/customize-dev-env.html" class="sidebar-item" aria-label="定制开发环境"><!--[--><!--]--> 定制开发环境 <!--[--><!--]--></a><!----></li><li><a href="/PolarDB-for-PostgreSQL/zh/guide/deploy-more.html" class="sidebar-item" aria-label="更多部署方式"><!--[--><!--]--> 更多部署方式 <!--[--><!--]--></a><!----></li><li><p tabindex="0" class="sidebar-item">特性体验 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/PolarDB-for-PostgreSQL/zh/guide/tpch-on-px.html" class="sidebar-item" aria-label="利用 PolarDB HTAP 加速 TPC-H"><!--[--><!--]--> 利用 PolarDB HTAP 加速 TPC-H <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="polardb-pg-备份恢复" tabindex="-1"><a class="header-anchor" href="#polardb-pg-备份恢复" aria-hidden="true">#</a> PolarDB PG 备份恢复</h1><p>本文将指导您如何对 PolarDB 做备份恢复，搭建只读节点，搭建 Standby 实例等。</p><p>首先我们先准备一个 PolarDB 实例，如何搭建 PolarDB 可以参考文档 <a href="https://apsaradb.github.io/PolarDB-for-PostgreSQL/zh/guide/db-pfs.html" target="_blank" rel="noopener noreferrer">搭建 PolarDB<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>注意：PolarDB 是基于共享存储的存算分离架构，因此 PolarDB 的备份恢复和 Postgres 有着许多不同。接下来我们将从以下几点来介绍 PolarDB 的备份恢复。</p><ol><li>PolarDB 备份恢复原理</li><li>PolarDB 的目录结构</li><li>polar_basebackup 备份工具</li><li>PolarDB 搭建 RO</li><li>PolarDB 搭建 Standby</li><li>PolarDB 按时间点恢复</li></ol><h2 id="备份恢复原理" tabindex="-1"><a class="header-anchor" href="#备份恢复原理" aria-hidden="true">#</a> 备份恢复原理</h2><p><img src="https://intranetproxy.alipay.com/skylark/lark/0/2022/png/135683/1656473213509-02fd756c-a796-47e0-af3b-cb7ce7e02751.png" alt="undefined"> PolarDB 的备份恢复整体原理几乎和 Postgres 一致，总结为以下几步： (1) 执行 pg_start_backup 命令 (2) 使用各种方式对数据库进行复制。 (3) 执行 pg_stop_backup 命令</p><p>进行备份的更简单方法是使用 polar_basebackup ，但它其实是在内部发出这些低级命令，并且支持使用网络将文件发送到远端。</p><ul><li>pg_start_backup pg_start_backup 准备进行基本备份。恢复过程从 REDO 点开始，因此 pg_start_backup 必须执行检查点以在开始进行基本备份时显式创建 REDO 点。此外，其检查点的检查点位置必须保存在 pg_control 以外的文件中，因为在备份期间可能会多次执行常规检查点。因此 pg_start_backup 执行以下四个操作：</li></ul><ol><li>强制进入整页写模式。</li><li>切换到当前的 WAL 段文件。</li><li>做检查点。</li><li>创建一个 backup_label 文件——该文件在基础目录的顶层创建，包含关于基础备份本身的基本信息，例如该检查点的检查点位置。 第三和第四个操作是这个命令的核心；执行第一和第二操作以更可靠地恢复数据库集群。</li></ol><ul><li>pg_stop_backup。 pg_stop_backup 执行以下五个操作来完成备份。</li></ul><ol><li>如果已被 pg_start_backup 强制更改，则重置为非整页写入模式。</li><li>写一条备份端的 XLOG 记录。</li><li>切换 WAL 段文件。</li><li>创建备份历史文件——该文件包含 backup_label 文件的内容和 pg_stop_backup 已执行的时间戳。</li><li>删除 backup_label 文件 – 从基本备份恢复需要 backup_label 文件，一旦复制，在原始数据库集群中就不需要了。</li></ol><h2 id="目录结构" tabindex="-1"><a class="header-anchor" href="#目录结构" aria-hidden="true">#</a> 目录结构</h2><p>如上所述，PolarDB 备份过程总体可以概括为三步，其中第二步是使用各种方式对数据库进行复制，也就是说，您可以在第二步时使用各种方式对 PolarDB 数据集簇进行复制，可以手动的 copy，也可以使用网络工具传输，也可以基于存储进行打快照。因此，这里介绍一下 PolarDB 数据目录结构，以便于进一步理解备份恢复。 <img src="https://intranetproxy.alipay.com/skylark/lark/0/2022/png/135683/1656470771553-e0c32f21-2ca4-43a4-a0a8-44d8a15e7358.png" alt="undefined"> 如上图，PolarDB 是基于共享存储的，所以 PolarDB 在物理上有两个重要的数据目录，分别对应 Local Data （Local Dir），Shared Data（Shared Dir）。</p><ol><li>Local Data （Local Dir）</li></ol><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>postgres=# show data_directory;
     data_directory
------------------------
 /home/postgres/primary
(1 row)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以通过上述命令在数据库中获取 Local Dir 的位置，可以看到它是类似于 Postgres 的 Data 目录。</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>.
├── base
│   ├── 1
│   ├── 13938
│   ├── 13939
│   └── 13940
├── global
├── pg_commit_ts
├── pg_csnlog
├── pg_dynshmem
├── pg_log
├── pg_logical
│   ├── mappings
│   └── snapshots
├── pg_logindex
├── pg_multixact
│   ├── members
│   └── offsets
├── pg_notify
├── pg_replslot
├── pg_serial
├── pg_snapshots
├── pg_stat
├── pg_stat_tmp
├── pg_subtrans
├── pg_tblspc
├── pg_xact
├── polar_cache_trash
├── polar_fullpage
└── polar_rel_size_cache
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>LocaL Dir 目录中，大多都是通过 initdb 命令生成的文件或目录，随着数据库服务运行，这里会生成更多的本地文件，如临时文件，缓存文件，配置文件，日志文件。<br> 在做备份时，Local Dir 是可选的，由于 Local 文件不涉及核心的数据文件，因此您也可以不去备份这个目录，仅仅备份 Shared Dir，然后用 initdb 重新生成一份新的 Local Dir，但是需要记住之前的配置信息，如 postgresql.conf，pg_hba.conf 等。注意如果您不能记住历史配置，或者您需要保留历史日志，建议您将 Local Dir 也进行备份，同样的可以将这个目录完全 copy 后修改配置文件来搭建 RO 或者 Standby。</p><ol start="3"><li>Shared Data（Shared Dir）</li></ol><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>postgres=# show polar_datadir;
     polar_datadir
-----------------------
 /nvme0n1/shared_data/
(1 row)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>.
├── base
│   ├── 1
│   ├── 16555
│   ├── 16556
│   ├── 16557
│   └── 16558
├── global
├── pg_commit_ts
├── pg_csnlog
├── pg_logindex
├── pg_multixact
│   ├── members
│   └── offsets
├── pg_replslot
├── pg_tblspc
├── pg_twophase
├── pg_wal
│   └── archive_status
├── pg_xact
├── polar_dma
│   ├── consensus_cc_log
│   └── consensus_log
├── polar_flog
├── polar_flog_index
├── polar_fraindex
│   ├── fbpoint
│   └── pg_xact
└── polar_fullpage
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Shared Dir 目录中，是 PolarDB 的核心数据文件，如表文件，索引文件，wal 日志，dma，logindex，flashback 等等。 这些文件被一个 RW 和多个 RO 共享，它是必须备份的。 您可以使用 copy 命令，存储快照，网络传输方式进行备份，如果您没有更好的选择，推荐使用 polar_basebackup 命令。</p><h2 id="polar-basebackup-备份工具" tabindex="-1"><a class="header-anchor" href="#polar-basebackup-备份工具" aria-hidden="true">#</a> polar_basebackup 备份工具</h2><p>首先我们需要介绍一下我们的备份工具 polar_basebackup，它由 <a href="https://www.postgresql.org/docs/11/app-pgbasebackup.html" target="_blank" rel="noopener noreferrer">pg_basebackup<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 改造而来，且完全兼容 pg_baseabckup，也就是说它同样可以用于对 Postgres 做备份恢复。 polar_basebackup 在 PolarDB 二进制安装目录下的 bin 目录中，您可以配置 export 环境变量来直接使用它。</p><div class="language-(英汉互译) ext-(英汉互译) line-numbers-mode"><pre class="language-(英汉互译)"><code>polar_basebackup takes a base backup of a running PostgreSQL server.

Usage:
  polar_basebackup [OPTION]...

Options controlling the output:
  -D, --pgdata=DIRECTORY receive base backup into directory
  -F, --format=p|t       output format (plain (default), tar)
  -r, --max-rate=RATE    maximum transfer rate to transfer data directory
                         (in kB/s, or use suffix &quot;k&quot; or &quot;M&quot;)
  -R, --write-recovery-conf
                         write recovery.conf for replication
  -T, --tablespace-mapping=OLDDIR=NEWDIR
                         relocate tablespace in OLDDIR to NEWDIR
      --waldir=WALDIR    location for the write-ahead log directory
  -X, --wal-method=none|fetch|stream
                         include required WAL files with specified method
  -z, --gzip             compress tar output
  -Z, --compress=0-9     compress tar output with given compression level

General options:
  -c, --checkpoint=fast|spread
                         set fast or spread checkpointing
  -C, --create-slot      create replication slot
  -l, --label=LABEL      set backup label
  -n, --no-clean         do not clean up after errors
  -N, --no-sync          do not wait for changes to be written safely to disk
  -P, --progress         show progress information
  -S, --slot=SLOTNAME    replication slot to use
  -v, --verbose          output verbose messages
  -V, --version          output version information, then exit
      --no-slot          prevent creation of temporary replication slot
      --no-verify-checksums
                         do not verify checksums
  -?, --help             show this help, then exit

Connection options:
  -d, --dbname=CONNSTR   connection string
  -h, --host=HOSTNAME    database server host or socket directory
  -p, --port=PORT        database server port number
  -s, --status-interval=INTERVAL
                         time between status packets sent to server (in seconds)
  -U, --username=NAME    connect as specified database user
  -w, --no-password      never prompt for password
  -W, --password         force password prompt (should happen automatically)
      --polardata=datadir  receive polar data backup into directory
      --polar_disk_home=disk_home  polar_disk_home for polar data backup
      --polar_host_id=host_id  polar_host_id for polar data backup
      --polar_storage_cluster_name=cluster_name  polar_storage_cluster_name for polar data backup
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到 polar_basebackup 的大多参数即用法都和 <a href="https://www.postgresql.org/docs/11/app-pgbasebackup.html" target="_blank" rel="noopener noreferrer">pg_basebackup<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 一致，只是多了以下几个参数，下面重点来介绍一下：</p><ul><li>polardata 如果您备份的实例是 PolarDB 共享存储架构，这个参数用于指定 PolarDB 共享存储目录（Shared Dir）的位置。如果您不指定，将会使用默认目录 polar_shared_data，并且放在 Local Dir （即 -D, --pgdata 所指定的参数）下面。如果您对 Postgres 备份则无需关心他。</li><li>polar_disk_home 如果您备份的实例是 PolarDB 共享存储架构，且您希望将 Shared Dir 通过 pfs 写入共享存储设备，则需要指定这个参数，它是 pfs 的使用参数。</li><li>polar_host_id 如果您备份的实例是 PolarDB 共享存储架构，且您希望将 Shared Dir 通过 pfs 写入共享存储设备，则需要指定这个参数，它是 pfs 的使用参数。</li><li>polar_storage_cluster_name 如果您备份的实例是 PolarDB 共享存储架构，且您希望将 Shared Dir 通过 pfs 写入共享存储设备，则需要指定这个参数，它是 pfs 的使用参数。</li></ul><h2 id="搭建-ro" tabindex="-1"><a class="header-anchor" href="#搭建-ro" aria-hidden="true">#</a> 搭建 RO</h2><p>您可以通过以下两种方式来搭建 RO node。</p><ol><li>使用 initdb 来搭建 RO 主要步骤是使用 initdb 初始化 RO 的 Local Dir 目录，然后修改配置文件，启动实例。具体请参考<a href="https://apsaradb.github.io/PolarDB-for-PostgreSQL/zh/guide/db-pfs.html#%E5%8F%AA%E8%AF%BB%E8%8A%82%E7%82%B9%E9%83%A8%E7%BD%B2" target="_blank" rel="noopener noreferrer">只读节点部署<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li>备份 RW 的 Local Dir 来搭建 RO 这里是将第一种方式的 initdb 初始化 RO 的 Local Dir 替换成备份 RW 的 Local Dir。 我们这里使用 polar_basebakcup 来演示。 <code>polar_basebackup --host=[主节点所在IP] --port=5432 -D /home/postgres/replica1 -X stream --progress --write-recovery-conf -v</code><img src="https://intranetproxy.alipay.com/skylark/lark/0/2022/png/135683/1656301721373-90677c11-9e82-4b5b-a60d-ea2e101cf81a.png" alt="undefined"> 完成 polar_basebackup 命令后，我们可以看到<code>/home/postgres/replica1</code> 中存在一个<code>polar_shared_data</code>, 搭建 RO 时不需要它，将它删除<code>rm -rf /home/postgres/replica1/polar_shared_data</code><img src="https://intranetproxy.alipay.com/skylark/lark/0/2022/png/135683/1656301745881-219b7540-3190-4cfe-a717-4083d579cc3a.png" alt="undefined"> 打开 /home/postgres/replica1/postgresql.conf，修改如下配置项：</li></ol><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>port=5433
polar_hostid=2
polar_enable_shared_storage_mode=on
polar_disk_name=&#39;nvme0n1&#39;
polar_datadir=&#39;/nvme0n1/shared_data/&#39;
polar_vfs.localfs_mode=off
shared_preload_libraries=&#39;$libdir/polar_vfs,$libdir/polar_worker&#39;
polar_storage_cluster_name=&#39;disk&#39;
logging_collector=on
log_line_prefix=&#39;%p\t%r\t%u\t%m\t&#39;
log_directory=&#39;pg_log&#39;
listen_addresses=&#39;*&#39;
max_connections=1000
synchronous_standby_names=&#39;&#39;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>/home/postgres/replica1/recovery.conf，使用以下配置项替换文件中的所有内容：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>polar_replica=&#39;on&#39;
recovery_target_timeline=&#39;latest&#39;
primary_slot_name=&#39;replica1&#39;
primary_conninfo=&#39;host=[主节点所在IP] port=5432 user=postgres dbname=postgres application_name=replica1&#39;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>最后，启动只读节点：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>$HOME/tmp_basedir_polardb_pg_1100_bld/bin/pg_ctl start -D $HOME/replica1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>检查只读节点能否正常运行：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>$HOME/tmp_basedir_polardb_pg_1100_bld/bin/psql \
    -p 5433 \
    -d postgres \
    -c &#39;select version();&#39;
            version
--------------------------------
 PostgreSQL 11.9 (POLARDB 11.9)
(1 row)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="搭建-standby" tabindex="-1"><a class="header-anchor" href="#搭建-standby" aria-hidden="true">#</a> 搭建 Standby</h2><p>您可以使用全量备份集搭建 Standby，这里推荐使用 polar_basebackup 进行搭建，下面介绍搭建流程。</p><ol><li>使用 polar_basebakcup 对实例作全量备份</li></ol><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>polar_basebackup --host=[主节点所在IP] --port=5432 -D /home/postgres/standby --polardata=/nvme0n2/shared_data/  --polar_storage_cluster_name=disk --polar_disk_name=nvme0n2  --polar_host_id=3 -X stream --progress --write-recovery-conf -v
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="https://intranetproxy.alipay.com/skylark/lark/0/2022/png/135683/1656315576998-2aaeff3e-4341-46df-bce1-eb211ea4c605.png" alt="undefined"> 注意：这里是构建共享存储的 Standby，首先您需要找一台机器部署好了 PolarDB 及其文件系统 PolarFS，且已经搭建好了共享存储<code>nvme0n2</code>, 具体操作请参考<a href="https://apsaradb.github.io/PolarDB-for-PostgreSQL/zh/guide/deploy.html" target="_blank" rel="noopener noreferrer">准备块设备与搭建文件系统<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 备份完成后如下： <img src="https://intranetproxy.alipay.com/skylark/lark/0/2022/png/135683/1656315627036-15320d4f-3711-4400-b094-b698edfa8caa.png" alt="undefined"></p><p>注意：如果您没有共享存储设备，则您不需要指定--polar_storage_cluster_name， --polar_disk_name，polar_host_id 参数。下面我们简单介绍下其他形态的 PolarDB 备份：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>-- 单节点本地备份
polar_basebackup -D /polardb/data-standby -X stream  --progress --write-recovery-conf -v
--共享存储本地备份
polar_basebackup -D /polardb/data-standby --polardata=/polardb/data-local  -X stream --progress --write-recovery-conf -v
-- 共享存储写入pfs
polar_basebackup -D /polardb/data-standby --polardata=/nvme7n1/data  --polar_storage_cluster_name=disk --polar_disk_name=nvme7n1  --polar_host_id=3
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>检查备份是否正常查看 Local Dir 与 Shared Dir Local Dir <img src="https://intranetproxy.alipay.com/skylark/lark/0/2022/png/135683/1656315747873-16bf409d-d58f-4e65-b1e0-1ae0e523b863.png" alt="undefined"> Shared Dir <img src="https://intranetproxy.alipay.com/skylark/lark/0/2022/png/135683/1656315649979-c0731ab7-4516-4e5e-9626-93ccdd1abab4.png" alt="undefined"></li><li>修改 postgresql.conf 中的下列参数值如下所示：</li></ol><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>polar_hostid = 3
polar_disk_name = &#39;nvme0n2&#39;
polar_datadir = &#39;/nvme0n2/shared_data&#39;
polar_storage_cluster_name = &#39;disk&#39;
synchronous_standby_names=&#39;&#39;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="4"><li>在主库中创建复制槽</li></ol><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>psql --host=[主节点所在IP]  --port=5432 -d postgres -c &#39;SELECT * FROM pg_create_physical_replication_slot(&#39;standby1&#39;);&#39;
 slot_name | lsn
-----------+-----
 standby1  |
(1 row)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="5"><li>在 Standby 的 Local Dir 中 recovery.conf 文件中增加如下参数</li></ol><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>recovery_target_timeline = &#39;latest&#39;
primary_slot_name = &#39;standby1&#39;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ol start="5"><li>启动 Standby</li></ol><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code> $HOME/tmp_basedir_polardb_pg_1100_bld/bin/pg_ctl start -D $HOME/standby
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ol start="6"><li>验证 Standby</li></ol><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>psql --host=[master所在IP] --port=5432 -d postgres -c &quot;create table t(t1 int primary key, t2 int);insert into t values (1, 1),(2, 3),(3, 3);&quot;
CREATE TABLE
INSERT 0 3

psql --host=[standby所在IP] --port=5432 -d postgres -c &#39; select * from t;&#39;
t1 | t2
----+----
 1 |  1
 2 |  3
 3 |  3
(3 rows)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="按时间点恢复" tabindex="-1"><a class="header-anchor" href="#按时间点恢复" aria-hidden="true">#</a> 按时间点恢复</h2><p>可以参考 Postgres 按时间点恢复<a href="http://www.postgres.cn/docs/11/continuous-archiving.html" target="_blank" rel="noopener noreferrer">PITR<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a><img src="https://intranetproxy.alipay.com/skylark/lark/0/2022/png/135683/1656473229849-8b7dbf39-2830-45e1-a076-adea16c06366.png" alt="undefined"> 其原理如图所示，使用备份集加上归档日志，可以恢复出任意历史时刻的 PolarDB 实例。</p></div><!--[--><!--]--></div><footer class="page-meta"><div class="meta-item edit-link"><a class="external-link meta-item-label" href="https://github.com/ApsaraDB/PolarDB-for-PostgreSQL/edit/main/zh/guide/backup-and-restore.md" rel="noopener noreferrer" target="_blank" aria-label="在 GitHub 上编辑此页"><!--[--><!--]--> 在 GitHub 上编辑此页 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="meta-item last-updated"><span class="meta-item-label">上次更新: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">贡献者: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: adger.lj@alibaba-inc.com">adger.lj</span><!----><!--]--><!--]--></span></div></footer><nav class="page-nav"><p class="inner"><span class="prev"><a href="/PolarDB-for-PostgreSQL/zh/guide/deploy.md" class="" aria-label="进阶部署"><!--[--><!--]--> 进阶部署 <!--[--><!--]--></a></span><span class="next"><a href="/PolarDB-for-PostgreSQL/zh/guide/customize-dev-env.html" class="" aria-label="定制开发环境"><!--[--><!--]--> 定制开发环境 <!--[--><!--]--></a></span></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/PolarDB-for-PostgreSQL/assets/app.d42591db.js" defer></script>
  </body>
</html>
